$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://sonovore.com/schemas/coordination/v1"
version: "1.0.0"
title: "Coordination Message Schema"
description: "Schema for cue-based coordination (WARNING/STANDBY/GO/STOP)"

type: object
required:
  - message_id
  - timestamp
  - sender
  - recipient
  - message_type
  - cue_id

properties:
  message_id:
    type: string
    format: uuid
    description: "Unique identifier for this message (UUID v4)"

  timestamp:
    type: string
    format: date-time
    description: "ISO 8601 UTC timestamp (YYYY-MM-DDTHH:MM:SSZ)"

  sender:
    type: string
    pattern: "^[a-z0-9]+(-[a-z0-9]+)*$"
    description: "Sender agent ID in kebab-case (usually orchestrator)"

  recipient:
    type: string
    pattern: "^([a-z0-9]+(-[a-z0-9]+)*|broadcast)$"
    description: "Recipient agent ID in kebab-case or 'broadcast' for multi-agent cues"

  message_type:
    type: string
    enum:
      - "coord.warning"
      - "coord.standby"
      - "coord.go"
      - "coord.stop"
    description: "Type of coordination message"

  cue_id:
    type: string
    pattern: "^CUE-[0-9]+(\\.[0-9]+)?$"
    description: "Cue identifier (e.g., CUE-100, CUE-200.5)"

  # Common fields for all coordination messages
  cue_group:
    type: string
    description: "Group or sequence this cue belongs to"

  target_agents:
    type: array
    items:
      type: string
      pattern: "^[a-z0-9]+(-[a-z0-9]+)*$"
    minItems: 1
    description: "List of agents involved in this coordinated action"

  # WARNING-specific fields
  warning_details:
    type: object
    properties:
      estimated_go_time:
        type: string
        format: date-time
        description: "Estimated time when GO will be issued"

      preparation_required:
        type: array
        items:
          type: string
        description: "List of preparation steps agents should complete"

      preparation_deadline:
        type: string
        format: date-time
        description: "When preparation must be complete"

      context:
        type: object
        additionalProperties: true
        description: "Additional context for preparation"

  # STANDBY-specific fields
  standby_details:
    type: object
    properties:
      ready_check:
        type: array
        items:
          type: string
        description: "Questions agents must answer affirmatively before GO"

      dependencies:
        type: array
        items:
          type: string
        description: "Dependencies that must be met before GO"

      timeout:
        type: string
        format: date-time
        description: "Maximum time to wait for all STANDBY acknowledgments"

  # GO-specific fields
  go_details:
    type: object
    properties:
      execution_type:
        type: string
        enum: ["immediate", "scheduled"]
        description: "Whether to execute immediately or at scheduled time"

      scheduled_time:
        type: string
        format: date-time
        description: "If scheduled, when to execute"

      synchronization:
        type: string
        enum: ["simultaneous", "sequential"]
        description: "Whether agents execute simultaneously or in sequence"

      sequence_order:
        type: array
        items:
          type: string
          pattern: "^[a-z0-9]+(-[a-z0-9]+)*$"
        description: "If sequential, the order of execution"

  # STOP-specific fields
  stop_details:
    type: object
    properties:
      reason:
        type: string
        description: "Why the STOP was issued"

      urgency:
        type: string
        enum: ["immediate", "graceful"]
        description: "Whether to stop immediately or allow graceful shutdown"

      rollback_required:
        type: boolean
        description: "Whether agents should rollback changes"

      next_action:
        type: string
        description: "What agents should do after stopping"

  # Auto-follow chains
  auto_follow:
    type: string
    pattern: "^CUE-[0-9]+(\\.[0-9]+)?$"
    description: "Next cue to automatically trigger upon completion (if any)"

additionalProperties: false
